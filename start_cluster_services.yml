---
- name: Check if the dfs is running
  command: jps
  register: jps_task
  changed_when: false

- name: Start the dfs if not running
  command: "{{ hadoop_home }}/sbin/start-dfs.sh"
  when: '"NameNode" not in jps_task.stdout'

- name: Check if we have the spark logs directory on hdfs
  command: "{{ hadoop_home }}/bin/hdfs dfs -test -d /spark-logs"
  failed_when: false
  changed_when: false
  register: spark_logs_test

- name: Create spark logs directory if missing
  command: "{{ hadoop_home }}/bin/hdfs dfs -mkdir /spark-logs"
  when: spark_logs_test.rc == 1

- name: Start yarn if not running
  shell: "nohup {{ hadoop_home }}/sbin/start-yarn.sh"
  when: '"ResourceManager" not in jps_task.stdout'

- name: Start yarn history server if not running
  shell: "nohup {{ hadoop_home }}/bin/mapred --daemon start historyserver"
  when: '" JobHistoryServer" not in jps_task.stdout'

- name: Start spark history server if not running
  shell: "nohup {{ spark_home }}/sbin/start-history-server.sh"
  when: '" HistoryServer" not in jps_task.stdout'
